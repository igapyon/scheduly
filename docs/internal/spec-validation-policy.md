# バリデーション方針（フロントエンド UX）
<!-- file moved to spec-validation-policy.md by docs prefix policy -->

この文書は、現行のオンメモリ実装（React/webpack）における入力バリデーションの扱いを整理します。特に文字数上限とユーザー体験（UX）を中心に、将来のサーバ/API 移行時にも整合性を保てる方針を示します。

## 原則
- ユーザー入力を破壊しない（検証エラーでも値は消さない）。
- 編集中はソフトに検証し、可能な限りブロックしない（値が完成した時のみ厳密に）。
- 明確に伝える（赤枠ハイライト＋トースト/インライン表示。例外で画面を遮らない）。
- クライアント/サーバで整合させる（上限やスキーマを共通化し移行容易に）。

## 振る舞いモデル
- 視覚的フィードバック
  - フィールド: 無効時は赤枠（値は保持）。
  - 文字カウンタ: 現在/最大を表示。上限超過で赤表示。
  - ステータス/トースト: 短いメッセージで修正点を案内（例: 「コメントは500文字以内で入力してください」）。
- 検証の実行タイミング
  - テキスト入力: 入力のたびにカウンタ・赤枠評価。保存タイミングは各画面ポリシーに従う（後述）。
  - 日時（datetime-local）: 入力途中の未完成値を許容。完成時のみ構造検証。順序（dtend ≤ dtstart）は保存を許容しつつ、ハイライト＋トースト。
- ログ出力
  - 予期される検証失敗（422）は `console.debug` に記録（`console.error` は避ける）。

## フィールド上限（現行）
- プロジェクト
  - name: 120 文字
  - description: 2000 文字
- 候補（スケジュール）
  - summary: 120 文字
  - location: 120 文字
  - description: 2000 文字
  - status: enum [CONFIRMED, TENTATIVE, CANCELLED]
  - datetime: 厳密チェックは `YYYY-MM-DDTHH:MM`（`datetime-local`）形式で実施
- 参加者
  - displayName: 80 文字、必須、プロジェクト内で一意
- 回答
  - comment: 500 文字
  - mark: enum [o, d, x, pending]

## 画面別の保存ポリシー
- 管理（主催者）
  - プロジェクト名/説明: ライブ更新。上限超過はカウンタ/赤枠で示す。保存はブロックしない。
  - 候補（スケジュール）：
    - テキスト: 即時更新。上限超過はカウンタ/赤枠。
    - 日時: 入力途中は許容。完成時に構造チェック。順序（`dtend` ≤ `dtstart`）は入力を保持しつつハイライト＋トースト。
- 参加者（インライン編集）
  - マーク（○/△/×）: クリック即保存。
  - コメント: フォーカスアウト時に保存。500超は赤枠＋メッセージ。値は保持。
  - 参加者名変更: カウンタ表示（0/80）。上限超過やサービスエラー時は赤枠＋インラインエラー。

## 実装ノート
- スキーマは `src/frontend/shared/validation.js`（軽量ヘルパ。将来的に zod へ置換可）
  - `buildResponseRules`、`buildCandidateRules`、`buildParticipantRules`、共通プリミティブ（maxLength, enum 等）
- サービス層は検証失敗で `code = 422` の `Error` を投げる。UI は赤枠＋トーストにマッピング。
- 管理 UI はメッセージからフィールド名を抽出し、項目別エラーフラグを設定。

## 検証結果 → UI のマッピング
- 422（comment）: トースト「コメントは500文字以内で入力してください」＋赤枠＋カウンタ赤。
- 422（summary/location/description/name）: トースト「<field> は <limit> 文字以内で入力してください」（または一般メッセージ）＋赤枠＋カウンタ赤。
- 日時順序: トースト「dtend must be after dtstart」＋両フィールドをハイライト。入力は保持。

## 将来のサーバ/API
- 同じ上限と列挙をサーバ側でも適用し、422 を構造化詳細付きで返却。
- UI マッピングを簡素化するため、違反フィールド一覧のエコーバックを検討。

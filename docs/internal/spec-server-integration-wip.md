# Server Integration Plan (Draft)

このドキュメントは、Scheduly がクライアントサイド完結の実装からサーバー連携へ移行する際に検討すべきポイントを整理するためのたたき台です。現時点では詳細が未確定のため、TBD 項目を含むラフな構成になっています。

## 目的と前提

- 現行: `projectStore` がブラウザ `sessionStorage` を利用し、すべてのロジックがクライアント内で完結
- 初期サーバ実装: **単一プロセス / オンメモリ** の Node.js アプリとして立ち上げ、永続ストレージを持たない揮発運用を起点とする（プロセス再起動時に状態は消える前提）
- スケールアウトやマルチプロセス対応は後続フェーズで検討し、初期段階では単一ノード内でのトークン配布・ICS 生成・回答集計を完結させる
- 目標: Node.js ベースのサーバーを導入しても既存の JavaScript スタックを活かしつつ、永続化と複数クライアントの整合性を確保する
- 範囲: API 設計、ストレージ選定、データ移行手順、テスト/CI への影響

## 段階的移行プラン（ドラフト）

1. **API スケルトン作成（TBD）**  
   - Express などで `/projects`, `/candidates`, `/participants`, `/responses` の CRUD を定義する  
   - 認証/トークンの扱いは別ドキュメントで検討
2. **データストア選定（TBD）**  
   - 選択肢: SQLite, PostgreSQL, Document Store など  
   - モックとの親和性を考慮して JSON 互換スキーマから検討
3. **クライアントの段階移行**  
   - `sessionStorage` への書き込み箇所をラップし、API 経由の fetch へ差し替え可能な構造を用意  
   - 移行期間中は API とローカルストアを選択的に切り替えられるよう Feature Flag を検討
4. **ICS ワークフローへの組み込み（TBD）**  
   - ファイルアップロード/ダウンロードのハンドリング  
   - ICS の差分更新をサーバー側でどう管理するか

## サーバー健全性エンドポイント

最小構成の Node.js サーバーでも、稼働監視のためのヘルスチェックを提供する。

- `GET /api/healthz`
  - 目的: プロセスが起動し、HTTP ハンドラが応答できるかを確認するライブネスチェック。
  - 実装: 常に 200/`{"status":"ok"}` を返す（将来的に依存モジュール診断を足しても良い）。外部依存のチェックは含めない。
  - 運用: コンテナの `livenessProbe` や外形監視から定期ポーリング。

- `GET /api/readyz`
  - 目的: 初期化が完了し、リクエストを受け付けられる状態かを判定するレディネスチェック。
  - 実装: 起動時の初期ロード（設定読み込み、キャッシュウォーム、バックグラウンドジョブ初期化など）が完了していれば 200/`{"status":"ready"}`、未完了の場合は 503/`{"status":"starting"}` を返す。
  - 運用: ロードバランサや Kubernetes `readinessProbe` から利用し、503 を受け取った場合はトラフィックを振らない。

レスポンスボディは JSON 固定とし、追加メタデータ（ビルド番号やチェック項目）は `meta` フィールドで拡張する。API 認証は不要だが、外部公開する環境では IP 制限やヘッダ検証を前段で行う。

## テスト・CI への影響（メモ）

- API 層追加後のユニットテスト/統合テスト戦略（未策定）
- CI 上での lint / test 実行コマンドの拡張（TBD）
- ブラウザ E2E テスト導入のタイミング検討

## 未決事項 / ToDo

- [ ] 認証・アクセス制御の方式を検討する
- [ ] 本番ホスティング環境の候補を列挙する
- [ ] データ移行のリハーサル手順を決める

> このファイルは随時更新予定です。決定事項が固まり次第、各セクションを具体化していきます。

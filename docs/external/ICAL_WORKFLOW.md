# iCal (ICS) Workflow — External Spec

Scheduly における iCalendar (ICS) の取り扱いについて、外部仕様のみを記載します（内部実装・未実装の構想は含みません）。

> 補足: 通常のWebアプリと異なる方式上の特徴（秘密URLによるアクセス、リアルタイム保存、揮発前提など）は外部仕様にまとめています。`docs/external/EXTERNAL_ASSUMPTIONS.md` を参照してください。

## 1. ワークフロー概要（外部仕様）

- 管理画面で ICS をインポートし、候補を取り込めます（プレビュー確認あり）。
- 候補の編集や参加者の回答は即時に反映され、一覧やサマリーへ反映されます。
- 必要に応じて、個別候補または全候補の ICS をエクスポートできます。

## 2. 外部カレンダーで作成 → Scheduly にインポート

1. Google Calendar など外部サービスで予定を作成し、ICS としてエクスポート。
2. 管理画面の「ICS から追加」でファイルを選択し、プレビューで内容を確認。
3. インポート時は `UID` と `DTSTAMP` を用いてマージします。既存 UID と一致し `DTSTAMP` が新しいものは更新、未知の UID は新規追加。
4. 取り込んだ候補は Scheduly 内で編集・配布・参加者回答に利用できる。

### このルートの特徴
- 外部サービス側で詳細調整したイベントを Scheduly へ連携させたいケースに適する。
- ICS には `UID` と `DTSTAMP` が必須。外部サービスとの二重管理になるため、どちらを最新ソースとするか運用ルールを明確にする。
- インポート直後に `icsText` が更新されるため、参加者側の「全候補を ICS でダウンロード」にも同内容が提供される。

## 3. Scheduly 内で直接入力 → 必要に応じて ICS をエクスポート

1. 管理画面で候補（日時・場所・説明など）を直接編集します。
2. 個別候補または全候補の ICS を生成してダウンロードできます（`SEQUENCE` と `DTSTAMP` は適切に更新されます）。
3. 参加者画面でも全候補の一括エクスポートが可能です。

### このルートの特徴
- Scheduly をシングルソースとみなし、候補編集から参加者回答までをアプリ内で完結できる。
- エクスポート時に `rawICalVevent` を更新しておくことで、再度 ICS をインポートしても差分判定がしやすい。
- 外部連携が不要なチームではこのルートのみで運用可能。

## 4. ICS メタデータ方針（外部仕様）

| 項目 | 役割 |
|------|------|
| UID | 候補のユニーク識別子。インポート/エクスポートの突き合わせに使用。|
| DTSTAMP | 更新時刻。インポート時の新旧判定に利用。|
| SEQUENCE | 版数。候補の更新に伴い増分。|
| DTSTART / DTEND | 開始・終了時刻。外部カレンダーでの表示に使用。|
| TZID | タイムゾーン ID。指定がない場合の既定や書式は現行仕様に従う。|
| LOCATION / DESCRIPTION / STATUS | 補足情報として出力。|

---

内部実装の詳細は `docs/internal/ICAL_INTERNALS.md` を参照してください。未実装・将来検討中の事項は `docs/internal/DEVELOPER_NOTES.md` に集約しています。
